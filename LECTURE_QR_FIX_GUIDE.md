# Lecture QR Attendance - Complete Fix Guide

## Root Cause Analysis

The error **"Server error: column 'studentId' does not exist"** was caused by:
1. **Data type mismatch**: `studentId` was being treated as a string instead of converted to integer
2. **Database column naming**: The database uses snake_case (`student_id`), but the code was using camelCase (`studentId`)
3. **Missing type conversion**: JSON input `studentId` needs to be parsed as an integer for SQL queries

## Fixed Issues

### 1. Fixed Student ID Type Conversion
- Added `parseInt(String(studentId), 10)` to properly convert to integer
- Added validation to check `isNaN(studentIdNum)`
- Updated all database queries to use `${studentIdNum}` instead of `${studentId}`

### 2. Fixed Database Column References
- All queries now properly use `student_id` column (which already exists in your database)
- No changes needed to database schema

### 3. Enhanced Error Logging
- Added detailed console logs to trace execution flow
- Better error messages for debugging

## Step-by-Step Verification

### Step 1: Verify Database Tables Exist
Go to: `http://your-domain/api/student/lectures/qr/debug`

Expected response should show:
```json
{
  "success": true,
  "tables": {
    "lecture_qr_tokens": "exists",
    "lecture_qr_submissions": "exists",
    "lecture_attendance": "exists"
  },
  "recent_tokens": [...]
}
```

### Step 2: Verify Tutor Can Create QR
1. Log in as tutor
2. Create a new lecture
3. Click "Generate QR Code"
4. Should see QR code with URL like: `https://your-domain/lectures/qr/[UUID]/attend`

### Step 3: Verify Student Enrollment
Before testing QR scan:
1. Confirm student is enrolled in the course
2. Confirm current_semester matches lecture's semester
3. Check database directly if needed

### Step 4: Test Student QR Scan
1. Log in as student
2. Click "Scan Lecture QR Code"
3. Scan the QR code generated by tutor
4. Should see success message: "Attendance marked successfully"

## Debugging Checklist

- [ ] Database migration ran successfully (visit `/setup-db`)
- [ ] All 3 tables exist (`lecture_qr_tokens`, `lecture_qr_submissions`, `lecture_attendance`)
- [ ] Student is enrolled in correct course
- [ ] Student's `current_semester` matches lecture's semester
- [ ] Tutor generated fresh QR code (within 4 seconds)
- [ ] Student logged in with correct account
- [ ] Browser console shows extracted token matching QR

## Common Issues & Solutions

### Issue: "Invalid or expired QR code" (404)
- **Cause**: Token not found in database or expired (>4 seconds old)
- **Solution**: 
  - Have tutor generate a fresh QR code
  - Ensure student scans within 4 seconds of generation
  - Check if `lecture_qr_tokens` table has the token

### Issue: "Server error: column 'studentId' does not exist" (Now Fixed!)
- **Cause**: Type conversion issue
- **Solution**: Already fixed in updated route.ts
- **What changed**: Added `parseInt(String(studentId), 10)` conversion

### Issue: "You are not enrolled for this lecture's course/semester"
- **Cause**: Student not in correct course/semester
- **Solution**:
  - Verify student enrollment in admin panel
  - Check student's `current_semester` field
  - Check lecture's course and semester

### Issue: "Attendance already marked for this lecture"
- **Cause**: Student already marked present
- **Solution**: This is normal - prevents duplicate marking
- **Expected behavior**: Student cannot scan same QR twice

### Issue: Infinite retries / continuous 404 errors
- **Cause**: 
  - Route file not saved
  - Environment variables not set
  - DATABASE_URL not configured
- **Solution**: 
  - Verify all code changes were saved
  - Check DATABASE_URL in environment variables
  - Redeploy application

## Console Output Examples

### Successful Flow (Browser Console)
```
[v0] QR URL received: https://v0-lecture-qr-attendance.vercel.app/lectures/qr/21cb76fc-4c99-4857-8fa0-64e56cb870c2/attend
[v0] Extracted token: 21cb76fc-4c99-4857-8fa0-64e56cb870c2
[v0] Submitting QR attendance with token: 21cb76fc-4c99-4857-8fa0-64e56cb870c2 studentId: 1
[v0] Response status: 200
[v0] Response data: {success: true, message: "Attendance marked successfully", ...}
```

### Failed Flow with Fix Applied
```
[v0] Lecture QR attend called with token: 21cb76fc-4c99-4857-8fa0-64e56cb870c2 studentId: 1 original: 1
[v0] Token found, fresh: true age: 1234 ms
[v0] Enrollment verified successfully
[v0] Attendance marked successfully: [{id: 123}]
```

## Next Steps

1. **Deploy the fixed code**
   - Changes made to `/app/api/student/lectures/qr/[token]/attend/route.ts`
   - No database schema changes needed

2. **Test the complete flow**
   - Tutor creates lecture and generates QR
   - Student scans QR and gets success message
   - Check `lecture_attendance` table for new record

3. **Monitor for issues**
   - Watch browser console for errors
   - Check server logs for "Server error:" messages
   - All errors should now have proper error codes (not 500)

## Support

If you still see errors after applying this fix:
1. Check the console logs in browser (F12 > Console tab)
2. Verify environment variables are set correctly
3. Ensure database migration completed successfully
4. Check that all code changes were deployed

The fix changes all `studentId` references to properly convert from JSON string to integer before using in SQL queries.
